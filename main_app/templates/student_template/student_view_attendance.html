{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{page_title}}{% endblock page_title %}
{% block content %}

<section class="content aegis-section">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <!-- general form elements -->
                <div class="card card-dark">
                    <div class="card-header">
                        <h3 class="card-title">{{page_title}}</h3>
                    </div>
                    <!-- /.card-header -->
                    <!-- form start -->
                    <div class="card-body">



                        {% if not course %}
                        <div class="alert alert-warning">
                            Your course is not assigned yet. Please contact the admin.
                        </div>
                        {% endif %}
                        <div class="form-group">
                            <label>Course</label>
                            <select  id="course" class="form-control" disabled>
                                <option value="{% if course %}{{ course.id }}{% endif %}">{% if course %}{{ course }}{% else %}----{% endif %}</option>
                            </select>
                            {% if course %}
                            <input type="hidden" id="course_hidden" value="{{ course.id }}">
                            {% endif %}
                        </div>
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label>Start Date</label>
                                    <input type="date" class="form-control" placeholder="Start Date" name="start_date" required id="start_date" {% if not course %}disabled{% endif %}>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label>End Date</label>
                                    <input type="date" class="form-control" placeholder="End Date" name="end_date"  id="end_date" {% if not course %}disabled{% endif %}>
                                </div>
                            </div>
                            <div class="col-12">
                                <button type="button" id="fetch_attendance" class="btn btn-success w-100" {% if not course %}disabled{% endif %}>Fetch Attendance Data</button>
                            </div>
                        </div>

                    </div>
                    <!-- /.card-body -->

                    {% if course %}
                    <div class="card-footer" style="overflow: auto; max-height: 400px;">
                        <div class="row g-2" id="attendance_data"></div>
                    </div>
                    {% else %}
                    <div class="card-footer">
                        <div class="alert alert-info mb-0">
                            Attendance data will appear here once your course is assigned.
                        </div>
                    </div>
                    {% endif %}
                </div>
                <!-- /.card -->

            </div>
        </div>
    </div>
</section>
{% endblock content %}


{% block custom_js %}
<script>
    $(document).ready(function () {

       
        $("#fetch_attendance").click(function () {
            var course = "{% if course %}{{ course.id }}{% endif %}"
            var start_date = $("#start_date").val()
            var end_date = $("#end_date").val()
            if (course.length  == 0 || end_date.length ==0 ||start_date.length == 0){
                alert("Please Select Course and Date Range");
                return false;
            }
            $("#attendance_data").html(null)
            $.ajax({
                url: "{% url 'student_view_attendance' %}",
                type: 'POST',
                data: {
                    course: course,
                    start_date: start_date,
                    end_date:end_date
                }
            }).done(function (response) {
                var json_data = JSON.parse(response)
                if (json_data.length < 1) {
                    $("#attendance_data").html("<div class='col-12 alert alert-warning'>No data for the selected range.</div>")
                } else {
                    var div_data = ""
                    
                    for (key in json_data) {
                        if (json_data[key]['status']){
                            div_data += "<div class='col-lg-3 col-md-4 col-sm-6'><div class='attendance-pill attendance-pill--present'><b>"+ json_data[key]['date'] + "</b><br/>Present</div></div>" 
                        } else {
                            div_data += "<div class='col-lg-3 col-md-4 col-sm-6'><div class='attendance-pill attendance-pill--absent'><b>"+ json_data[key]['date'] + "</b><br/>Absent</div></div>"
                        }
                    }
                    $("#attendance_data").html(div_data)
                }
            }).fail(function (response) {
                $("#attendance_data").html("<div class='col-12 alert alert-danger'>Error while fetching records.</div>")
            })


          

        })
    })
</script>
{% endblock custom_js %}
